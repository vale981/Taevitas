#include "cameramanager.h"
#include <QDebug>

using namespace FlyCapture2;

CameraManager::CameraManager(QObject *parent) : QObject(parent) {
	// Select first camera by default.
	if(numCameras() > 0)
		connectCamera(0);
	
}

void CameraManager::connectCamera(unsigned int index) {
	if(camera.IsConnected())
		camera.Disconnect();
	
	qDebug() << "Connecting to camera: " << index << '\n';	
	Error error; // general purpose error object
	
// get PGRGuid of the Camera
	error = bus_mgr.GetCameraFromIndex(index, &camera_guid);
	if(error != PGRERROR_OK) {
		emit camError(error);
		return;
	}

	// connectCamera
	error = camera.Connect(&camera_guid);
	if(error != PGRERROR_OK) {
		emit camError(error);
		return;
	}

	emit cameraConnected(&camera);
}

// The capture callback is a wrapper to emit the frameCaptured signal.
inline void CameraManager::captureCallback(FlyCapture2::Image* image, const void *camManager) {
	if(camManager)
		static_cast<const CameraManager*>(camManager)->frameCaptured(image);
}

void CameraManager::startCapture() {
	// Just a wrapper for the PTGrey method. Let all the errors be generated by the PTGrey method.
	// TODO: Evtl try to connect to first camera...
	Error error;

	error = camera.StartCapture(captureCallback, this);
}

